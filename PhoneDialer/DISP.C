
 /****************************************
 *                                       *
 *   DDDDD    IIIIII   SSSSS   PPPPPP    *
 *   DD  DD     II    SS   SS  PP   PP   *
 *   DD   DD    II    SS       PP   PP   *
 *   DD   DD    II     SSSSS   PPPPPP    *
 *   DD   DD    II         SS  PP        *
 *   DD  DD     II    SS   SS  PP        *
 *   DDDDD    IIIIII   SSSSS   PP        *
 *                                       *
 ****************************************/

#include <p18F4525.h>
#include "dev12.h"


/* table to convert ascii character to graphics bit values */
CONST char ascii[128][8] = {
   { 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00 },    // NULL
   { 0x00,0x55,0x55,0x55,0x55,0x55,0x55,0x55 },    // BORDER
   { 0xFF,0x00,0xFF,0x00,0xFF,0x00,0xFF,0x00 },    // BORDER
   { 0x00,0xFF,0x00,0xFF,0x00,0xFF,0x00,0xFF },    // BORDER
   { 0x00,0x00,0x00,0x42,0x66,0x3C,0x18,0x00 },    // BORDER
   { 0xFF,0x81,0x81,0x81,0x81,0x81,0x81,0xFF },    // BORDER
   { 0x00,0x18,0x0C,0x18,0x30,0x60,0x00,0x00 },    // BORDER
   { 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00 },    // BORDER
   { 0x00,0x10,0x28,0x44,0xFE,0x00,0x00,0x00 },    // SPECIAL
   { 0x00,0x00,0x44,0x38,0x00,0x00,0x00,0x00 },    // SPECIAL
   { 0x00,0x00,0x44,0x38,0x82,0x7C,0x00,0x00 },    // SPECIAL
   { 0x00,0x10,0x20,0x7E,0x20,0x10,0x00,0x00 },    // SPECIAL
   { 0x00,0x08,0x04,0x7E,0x04,0x08,0x00,0x00 },    // SPECIAL
   { 0x00,0x0E,0x3A,0x2A,0x3A,0x0E,0x00,0x00 },    // SPECIAL
   { 0x00,0x40,0x90,0xA4,0x90,0x40,0x00,0x00 },    // SPECIAL
   { 0x00,0x08,0x04,0x08,0x1C,0x20,0x00,0x00 },    // SPECIAL
   { 0x00,0x10,0x30,0x7E,0x7E,0x30,0x10,0x00 },    // SPECIAL
   { 0x00,0x18,0x3C,0x7E,0x18,0x18,0x18,0x00 },    // SPECIAL
   { 0x00,0x18,0x18,0x18,0x7E,0x7E,0x0C,0x08 },    // SPECIAL
   { 0x00,0x08,0x0C,0x7E,0x7E,0x0C,0x08,0x00 },    // SPECIAL
   { 0x00,0x08,0x04,0x02,0x0C,0x30,0x40,0x00 },    // SPECIAL
   { 0x00,0x42,0x24,0x18,0x18,0x24,0x42,0x00 },    // SPECIAL
   { 0x00,0x02,0x24,0x04,0x04,0x24,0x02,0x00 },    // SPECIAL
   { 0x00,0x04,0x22,0x02,0x02,0x22,0x04,0x00 },    // SPECIAL
   { 0x3C,0x66,0x42,0x42,0x42,0x42,0x42,0x42 },    // SPECIAL
   { 0x42,0x42,0x42,0x42,0x42,0x42,0x7E,0x00 },    // SPECIAL
   { 0x3C,0x7E,0x7E,0x7E,0x7E,0x7E,0x7E,0x7E },    // SPECIAL
   { 0x7E,0x7E,0x7E,0x7E,0x7E,0x7E,0x7E,0x00 },    // SPECIAL
   { 0x00,0x06,0x7E,0x60,0x6C,0x7C,0x00,0x00 },    // SPECIAL
   { 0x00,0x42,0x42,0x42,0x7E,0x7E,0x7E,0x00 },    // SPECIAL
   { 0x3C,0x66,0x42,0x42,0x42,0x7E,0x7E,0x7E },    // SPECIAL
   { 0x00,0x2A,0x28,0x2E,0x20,0x3E,0x00,0x00 },    // SPECIAL
   { 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00 },    // SPECIAL
   { 0x00,0x00,0x00,0x00,0xF2,0x00,0x00,0x00 },    // !
   { 0x00,0x00,0x00,0xE0,0x00,0xE0,0x00,0x00 },    // ”
   { 0x00,0x00,0x24,0xFE,0x24,0xFE,0x24,0x00 },    // #
   { 0x00,0x00,0x24,0x54,0xFE,0x54,0x48,0x00 },    // $
   { 0x00,0x00,0x62,0x64,0x08,0x13,0x23,0x00 },    // %
   { 0x00,0x00,0x6C,0x92,0xAA,0x44,0x0A,0x00 },    // &
   { 0x00,0x00,0x00,0xA0,0xC0,0x00,0x00,0x00 },    // ’
   { 0x00,0x38,0x44,0x82,0x00,0x00,0x00,0x00 },    // (
   { 0x00,0x00,0x00,0x82,0x44,0x38,0x00,0x00 },    // )
   { 0x00,0x00,0x28,0x10,0x7C,0x10,0x28,0x00 },    // *
   { 0x00,0x10,0x10,0x7C,0x10,0x10,0x00,0x00 },    // +
   { 0x00,0x00,0x00,0x0A,0x0C,0x00,0x00,0x00 },    // ,
   { 0x00,0x10,0x10,0x10,0x10,0x10,0x00,0x00 },    // -
   { 0x00,0x00,0x06,0x06,0x00,0x00,0x00,0x00 },    // .
   { 0x00,0x04,0x08,0x10,0x20,0x40,0x00,0x00 },    // /
   { 0x00,0x7C,0x8A,0x92,0xA2,0x7C,0x00,0x00 },    // 0
   { 0x00,0x00,0x42,0xFE,0x02,0x00,0x00,0x00 },    // 1
   { 0x00,0x42,0x86,0x8A,0x92,0x62,0x00,0x00 },    // 2
   { 0x00,0x84,0x82,0xA2,0xD2,0x8C,0x00,0x00 },    // 3
   { 0x00,0x18,0x28,0x48,0xFE,0x08,0x00,0x00 },    // 4
   { 0x00,0xE4,0xA2,0xA2,0xA2,0x9C,0x00,0x00 },    // 5
   { 0x00,0x3C,0x52,0x92,0x92,0x0C,0x00,0x00 },    // 6
   { 0x00,0x80,0x8E,0x90,0xA0,0xC0,0x00,0x00 },    // 7
   { 0x00,0x6C,0x92,0x92,0x92,0x6C,0x00,0x00 },    // 8
   { 0x00,0x60,0x92,0x92,0x94,0x78,0x00,0x00 },    // 9
   { 0x00,0x00,0x6C,0x6C,0x00,0x00,0x00,0x00 },    // :
   { 0x00,0x00,0x6A,0x6C,0x00,0x00,0x00,0x00 },    // ;
   { 0x00,0x00,0x10,0x28,0x44,0x82,0x00,0x00 },    // <
   { 0x00,0x28,0x28,0x28,0x28,0x28,0x00,0x00 },    // =
   { 0x00,0x82,0x44,0x28,0x10,0x00,0x00,0x00 },    // >
   { 0x00,0x40,0x80,0x8A,0x90,0x60,0x00,0x00 },    // ?
   { 0x00,0x4C,0x92,0x9E,0x82,0x7C,0x00,0x00 },    // @
   { 0x00,0x7E,0x88,0x88,0x88,0x7E,0x00,0x00 },    // A
   { 0x00,0xFE,0x92,0x92,0x92,0x6C,0x00,0x00 },    // B
   { 0x00,0x7C,0x82,0x82,0x82,0x44,0x00,0x00 },    // C
   { 0x00,0xFE,0x82,0x82,0x84,0x38,0x00,0x00 },    // D
   { 0x00,0xFE,0x92,0x92,0x92,0x82,0x00,0x00 },    // E
   { 0x00,0xFE,0x90,0x90,0x90,0x80,0x00,0x00 },    // F
   { 0x00,0x7C,0x82,0x92,0x92,0x5E,0x00,0x00 },    // G
   { 0x00,0xFE,0x10,0x10,0x10,0xFE,0x00,0x00 },    // H
   { 0x00,0x00,0x82,0xFE,0x82,0x00,0x00,0x00 },    // I
   { 0x00,0x04,0x02,0x82,0xFC,0x80,0x00,0x00 },    // J
   { 0x00,0xFE,0x10,0x28,0x44,0x82,0x00,0x00 },    // K
   { 0x00,0xFE,0x02,0x02,0x02,0x02,0x00,0x00 },    // L
   { 0x00,0xFE,0x40,0x30,0x40,0xFE,0x00,0x00 },    // M
   { 0x00,0xFE,0x20,0x10,0x04,0xFE,0x00,0x00 },    // N
   { 0x00,0x7C,0x82,0x82,0x82,0x7C,0x00,0x00 },    // O
   { 0x00,0xFE,0x90,0x90,0x90,0x60,0x00,0x00 },    // P
   { 0x00,0x7C,0x82,0x8A,0x84,0x7A,0x00,0x00 },    // Q
   { 0x00,0xFE,0x90,0x98,0x94,0x62,0x00,0x00 },    // R
   { 0x00,0x62,0x92,0x92,0x92,0x8C,0x00,0x00 },    // S
   { 0x00,0x80,0x80,0xFE,0x80,0x80,0x00,0x00 },    // T
   { 0x00,0xFC,0x02,0x02,0x02,0xFC,0x00,0x00 },    // U
   { 0x00,0xF8,0x04,0x02,0x04,0xF8,0x00,0x00 },    // V
   { 0x00,0xFC,0x02,0x1C,0x02,0xFC,0x00,0x00 },    // W
   { 0x00,0xC6,0x28,0x10,0x28,0xC6,0x00,0x00 },    // X
   { 0x00,0xE0,0x10,0x0E,0x10,0xE0,0x00,0x00 },    // Y
   { 0x00,0x86,0x8A,0x92,0xA2,0xC2,0x00,0x00 },    // Z
   { 0x00,0x00,0x00,0xFE,0x82,0x82,0x00,0x00 },    // {
   { 0x00,0x40,0x20,0x10,0x08,0x04,0x00,0x00 },    // '\'
   { 0x00,0x00,0x82,0x82,0xFE,0x00,0x00,0x00 },    // ]
   { 0x00,0x20,0x40,0x80,0x40,0x20,0x00,0x00 },    // ^
   { 0x00,0x02,0x02,0x02,0x02,0x02,0x00,0x00 },    // _
   { 0x00,0x00,0x80,0x40,0x20,0x00,0x00,0x00 },    // '
   { 0x00,0x04,0x2A,0x2A,0x2A,0x1E,0x00,0x00 },    // a
   { 0x00,0xFE,0x12,0x22,0x22,0x1E,0x00,0x00 },    // b
   { 0x00,0x1C,0x22,0x22,0x22,0x04,0x00,0x00 },    // c
   { 0x00,0x1C,0x22,0x22,0x12,0xFE,0x00,0x00 },    // d
   { 0x00,0x1C,0x2A,0x2A,0x2A,0x18,0x00,0x00 },    // e
   { 0x00,0x10,0x7E,0x90,0x80,0x40,0x00,0x00 },    // f
   { 0x00,0x30,0x4A,0x4A,0x4A,0x4A,0x7C,0x00 },    // g
   { 0x00,0xFE,0x10,0x20,0x20,0x20,0x1E,0x00 },    // h
   { 0x00,0x00,0x22,0xBE,0x02,0x00,0x00,0x00 },    // i
   { 0x00,0x04,0x02,0x22,0xBC,0x00,0x00,0x00 },    // j
   { 0x00,0xFE,0x08,0x14,0x22,0x00,0x00,0x00 },    // k
   { 0x00,0x00,0x82,0xFE,0x02,0x00,0x00,0x00 },    // l
   { 0x00,0x3E,0x20,0x18,0x20,0x1E,0x00,0x00 },    // m
   { 0x00,0x3E,0x10,0x20,0x20,0x1E,0x00,0x00 },    // n
   { 0x00,0x1C,0x22,0x22,0x22,0x1C,0x00,0x00 },    // o
   { 0x00,0x3E,0x48,0x48,0x48,0x30,0x00,0x00 },    // p
   { 0x00,0x60,0x90,0x90,0xFE,0x01,0x00,0x00 },    // q
   { 0x00,0x3E,0x10,0x20,0x20,0x10,0x00,0x00 },    // r
   { 0x00,0x3A,0x2A,0x2A,0x2A,0x2E,0x00,0x00 },    // s
   { 0x00,0x20,0x20,0x7E,0x20,0x20,0x00,0x00 },    // t
   { 0x00,0x1E,0x02,0x02,0x02,0x1E,0x00,0x00 },    // u
   { 0x00,0x18,0x04,0x02,0x04,0x18,0x00,0x00 },    // v
   { 0x00,0x1E,0x02,0x04,0x02,0x1E,0x00,0x00 },    // w
   { 0x00,0x22,0x14,0x08,0x14,0x22,0x00,0x00 },    // x
   { 0x00,0x30,0x0A,0x0A,0x0A,0x3C,0x00,0x00 },    // y
   { 0x00,0x22,0x26,0x2A,0x32,0x22,0x00,0x00 },    // z
   { 0x00,0x00,0x10,0x6C,0x82,0x00,0x00,0x00 },    // {
   { 0x00,0x00,0x00,0xFE,0x00,0x00,0x00,0x00 },    // |
   { 0x00,0x00,0x82,0x6C,0x10,0x00,0x00,0x00 },    // }
   { 0x00,0x10,0x20,0x10,0x08,0x10,0x00,0x00 },    // ~
   { 0x00,0x10,0x38,0x54,0x10,0x10,0x00,0x00 }     // DEL
};

/* place to buffer the lcd display page */
/* maps as 4 lines, 16 characters (each character uses 8 bytes) */
#pragma udata gbuff1
static BYTE page[4][128];
#pragma udata


//-----------------------------------------------------------------------------
// WriteDisplay
// Send the 8-bit data in the specified mode
//-----------------------------------------------------------------------------
static void WriteDisplay(BYTE mode, BYTE data)
{
   CS1B_PIN = 0;
   A0_PIN = mode;
   SSPBUF = data;
   while(PIR1bits.SSPIF == 0);
   CS1B_PIN = 1;
   PIR1bits.SSPIF = 0;
}


//-----------------------------------------------------------------------------
// WriteString
// Overwites the string onto the display (string is in CONST memory)
//-----------------------------------------------------------------------------
static void WriteString(BYTE row, BYTE col, CONST char *ptr)
{
   BYTE ofst;

   col <<= 3;
   while (*ptr != 0x00)
   {
      for (ofst=0; ofst<8; ofst++)
          page[row][col+ofst] = ascii[*ptr][ofst];
      col += 8;
      ptr++;
   }
}

// Overwites the string onto the display (string is in local data memory)
static void WriteBytes(BYTE row, BYTE col, char *ptr)
{
   BYTE ofst;

   col <<= 3;
   while (*ptr != 0x00)
   {
      for (ofst=0; ofst<8; ofst++)
          page[row][col+ofst] = ascii[*ptr][ofst];
      col += 8;
      ptr++;
   }
}


/* initialize the newhaven graphics display */
void DispInit(void)
{
    // http://www.newhavendisplay.com/forum/viewtopic.php?f=7&t=18#p54
    WriteDisplay(LCD_CMND,0xA0);   // (8) Display RAM adress SEG output correspondence: normal
    WriteDisplay(LCD_CMND,0xAE);   // (1) LCD Display: OFF, hmmm
    WriteDisplay(LCD_CMND,0xC0);   // (15) Set COM output scan direction: normal
    WriteDisplay(LCD_CMND,0xA2);   // (11) Sets the LCD drive voltage bias ration: 1/9 bias
    WriteDisplay(LCD_CMND,0x2F);   // (16) Internal power supply mode : Booster on, Voltage regulator on, voltage follower on
    WriteDisplay(LCD_CMND,0x20);   // (17) Internal resistor ratio:
    WriteDisplay(LCD_CMND,0x81);   // (18) Set the volume register with 0x3d (below)
    WriteDisplay(LCD_CMND,0x3f);   //
}

/****************************************************************
*        NAME : DispClear
* DESCRIPTION : clear the memory display (needs DispUpdate)
*       INPUT : none
*      OUTPUT : none
*     RETURNS : none
****************************************************************/
void DispClear(void)
{
   MemClear((BYTE *)page, sizeof(page));
}

/****************************************************************
*        NAME : DispConstText
* DESCRIPTION : write (flash) text to the display (needs DispUpdate)
*       INPUT : row = display row (0-3)
*             : col = display column (0-15)
*             : textp = pointer to null terminated text string
*      OUTPUT : none
*     RETURNS : none
****************************************************************/
void DispConstText(BYTE row, BYTE col, CONST char *textp)
{
   WriteString(row, col, textp);
}

/****************************************************************
*        NAME : DispText
* DESCRIPTION : write (ram) text to the display (needs DispUpdate)
*       INPUT : row = display row (0-3)
*             : col = display column (0-15)
*             : textp = pointer to null terminated text string
*      OUTPUT : none
*     RETURNS : none
****************************************************************/
void DispText(BYTE row, BYTE col, char *textp)
{
   WriteBytes(row, col, textp);
}

/****************************************************************
*        NAME : DispUpdate
* DESCRIPTION : write out the buffer to the graphics display
*       INPUT : none
*      OUTPUT : none
*     RETURNS : none
****************************************************************/
void DispUpdate(void)
{
   BYTE row,col;

   WriteDisplay(LCD_CMND, 0xAE);         // LCD display off

   for (row=0; row<4; row++)
   {
      WriteDisplay(LCD_CMND, 0xB0+row);  // point to the first "row"
      WriteDisplay(LCD_CMND, 0x10);      // and the 0th column
      WriteDisplay(LCD_CMND, 0x10);      // Column Address Set requires two writes

      for (col=0; col<128; col++)
      {
         WriteDisplay(LCD_DATA, page[3-row][col]);
      }
   }

   WriteDisplay(LCD_CMND,0xAF);          // LCD display on
}

/****************************************************************
*        NAME : KeyInput
* DESCRIPTION : polls the keypad
*       INPUT : none
*      OUTPUT : none
*     RETURNS : 0 if no characters are present
*             : ascii character (0-9, *, #)
****************************************************************/
BYTE KeyInput(void)
{
   extern BYTE keydata;
   BYTE key;

   key = keydata;    /* get key pad data (if present) */
   keydata = 0;      /* use 0 as an indicator that no data is present */

   return(key);
}

/****************************************************************
*        NAME : MemCopy
* DESCRIPTION : moves a block of memory
*       INPUT : dstp = pointer to the destination block
*             : srcp = pointer to the source block
*             : max = number of bytes to move
*      OUTPUT : *dstp = *srcp
*     RETURNS : none
****************************************************************/
void MemCopy(BYTE *dstp, BYTE *srcp, int max)
{
   for (; max > 0; max--)
      *dstp++ = *srcp++;
}

/****************************************************************
*        NAME : MemClear
* DESCRIPTION : clears a block of memory
*       INPUT : dstp = pointer to the memory block
*             : max = number of bytes to clear
*      OUTPUT : *dstp = zeroes
*     RETURNS : none
****************************************************************/
void MemClear(BYTE *dstp, int max)
{
   for (; max > 0; max--)
      *dstp++ = 0;
}

